import { Injectable, Logger } from '@nestjs/common';

export interface ParsedSiteOrder {
  city: string;
  site: string;
  clientName: string;
  phone: string;
  comment?: string;
}

@Injectable()
export class SiteOrdersParserService {
  private readonly logger = new Logger(SiteOrdersParserService.name);

  /**
   * –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è —Å–∞–π—Ç–æ–≤ –∏ –≥–æ—Ä–æ–¥–æ–≤
   * –î–æ–±–∞–≤–ª—è–π—Ç–µ –Ω–æ–≤—ã–µ —Å–∞–π—Ç—ã –ø–æ –º–µ—Ä–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
   */
  private readonly siteToCity: Record<string, string> = {
    // –í–æ–¥–æ–∫–∞–Ω–∞–ª—ã
    '–≤–æ–¥–æ–∫–∞–Ω–∞–ª55': '–û–º—Å–∫',
    '–≤–æ–¥–æ–∫–∞–Ω–∞–ª76': '–Ø—Ä–æ—Å–ª–∞–≤–ª—å',
    '–≤–æ–¥–æ–∫–∞–Ω–∞–ª54': '–ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫',
    '–≤–æ–¥–æ–∫–∞–Ω–∞–ª63': '–°–∞–º–∞—Ä–∞',
    '–≤–æ–¥–æ–∫–∞–Ω–∞–ª16': '–ö–∞–∑–∞–Ω—å',
    '–≤–æ–¥–æ–∫–∞–Ω–∞–ª02': '–£—Ñ–∞',
    '–≤–æ–¥–æ–∫–∞–Ω–∞–ª74': '–ß–µ–ª—è–±–∏–Ω—Å–∫',
    '–≤–æ–¥–æ–∫–∞–Ω–∞–ª66': '–ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥',
    '–≤–æ–¥–æ–∫–∞–Ω–∞–ª59': '–ü–µ—Ä–º—å',
    '–≤–æ–¥–æ–∫–∞–Ω–∞–ª52': '–ù–∏–∂–Ω–∏–π –ù–æ–≤–≥–æ—Ä–æ–¥',
    '–≤–æ–¥–æ–∫–∞–Ω–∞–ª61': '–†–æ—Å—Ç–æ–≤-–Ω–∞-–î–æ–Ω—É',
    '–≤–æ–¥–æ–∫–∞–Ω–∞–ª34': '–í–æ–ª–≥–æ–≥—Ä–∞–¥',
    '–≤–æ–¥–æ–∫–∞–Ω–∞–ª23': '–ö—Ä–∞—Å–Ω–æ–¥–∞—Ä',
    '–≤–æ–¥–æ–∫–∞–Ω–∞–ª03': '–£–ª–∞–Ω-–£–¥—ç',
    '–≤–æ–¥–æ–∫–∞–Ω–∞–ª38': '–ò—Ä–∫—É—Ç—Å–∫',
    '–≤–æ–¥–æ–∫–∞–Ω–∞–ª24': '–ö—Ä–∞—Å–Ω–æ—è—Ä—Å–∫',
    '–≤–æ–¥–æ–∫–∞–Ω–∞–ª25': '–í–ª–∞–¥–∏–≤–æ—Å—Ç–æ–∫',
    '–≤–æ–¥–æ–∫–∞–Ω–∞–ª27': '–•–∞–±–∞—Ä–æ–≤—Å–∫',
    '–≤–æ–¥–æ–∫–∞–Ω–∞–ª10': '–ü–µ—Ç—Ä–æ–∑–∞–≤–æ–¥—Å–∫',
    '–≤–æ–¥–æ–∫–∞–Ω–∞–ª51': '–ú—É—Ä–º–∞–Ω—Å–∫',
    '–≤–æ–¥–æ–∫–∞–Ω–∞–ª29': '–ê—Ä—Ö–∞–Ω–≥–µ–ª—å—Å–∫',
    '–≤–æ–¥–æ–∫–∞–Ω–∞–ª35': '–í–æ–ª–æ–≥–¥–∞',
    '–≤–æ–¥–æ–∫–∞–Ω–∞–ª44': '–ö–æ—Å—Ç—Ä–æ–º–∞',
    '–≤–æ–¥–æ–∫–∞–Ω–∞–ª37': '–ò–≤–∞–Ω–æ–≤–æ',
    '–≤–æ–¥–æ–∫–∞–Ω–∞–ª33': '–í–ª–∞–¥–∏–º–∏—Ä',
    '–≤–æ–¥–æ–∫–∞–Ω–∞–ª62': '–†—è–∑–∞–Ω—å',
    '–≤–æ–¥–æ–∫–∞–Ω–∞–ª71': '–¢—É–ª–∞',
    '–≤–æ–¥–æ–∫–∞–Ω–∞–ª40': '–ö–∞–ª—É–≥–∞',
    '–≤–æ–¥–æ–∫–∞–Ω–∞–ª57': '–û—Ä–µ–ª',
    '–≤–æ–¥–æ–∫–∞–Ω–∞–ª46': '–ö—É—Ä—Å–∫',
    '–≤–æ–¥–æ–∫–∞–Ω–∞–ª31': '–ë–µ–ª–≥–æ—Ä–æ–¥',
    '–≤–æ–¥–æ–∫–∞–Ω–∞–ª36': '–í–æ—Ä–æ–Ω–µ–∂',
    '–≤–æ–¥–æ–∫–∞–Ω–∞–ª48': '–õ–∏–ø–µ—Ü–∫',
    '–≤–æ–¥–æ–∫–∞–Ω–∞–ª68': '–¢–∞–º–±–æ–≤',
    '–≤–æ–¥–æ–∫–∞–Ω–∞–ª58': '–ü–µ–Ω–∑–∞',
    '–≤–æ–¥–æ–∫–∞–Ω–∞–ª64': '–°–∞—Ä–∞—Ç–æ–≤',
    '–≤–æ–¥–æ–∫–∞–Ω–∞–ª73': '–£–ª—å—è–Ω–æ–≤—Å–∫',
    '–≤–æ–¥–æ–∫–∞–Ω–∞–ª12': '–ô–æ—à–∫–∞—Ä-–û–ª–∞',
    '–≤–æ–¥–æ–∫–∞–Ω–∞–ª21': '–ß–µ–±–æ–∫—Å–∞—Ä—ã',
    '–≤–æ–¥–æ–∫–∞–Ω–∞–ª18': '–ò–∂–µ–≤—Å–∫',
    '–≤–æ–¥–æ–∫–∞–Ω–∞–ª43': '–ö–∏—Ä–æ–≤',
    '–≤–æ–¥–æ–∫–∞–Ω–∞–ª13': '–°–∞—Ä–∞–Ω—Å–∫',
    '–≤–æ–¥–æ–∫–∞–Ω–∞–ª56': '–û—Ä–µ–Ω–±—É—Ä–≥',
    '–≤–æ–¥–æ–∫–∞–Ω–∞–ª45': '–ö—É—Ä–≥–∞–Ω',
    '–≤–æ–¥–æ–∫–∞–Ω–∞–ª72': '–¢—é–º–µ–Ω—å',
    '–≤–æ–¥–æ–∫–∞–Ω–∞–ª86': '–•–∞–Ω—Ç—ã-–ú–∞–Ω—Å–∏–π—Å–∫',
    '–≤–æ–¥–æ–∫–∞–Ω–∞–ª89': '–°–∞–ª–µ—Ö–∞—Ä–¥',
    '–≤–æ–¥–æ–∫–∞–Ω–∞–ª70': '–¢–æ–º—Å–∫',
    '–≤–æ–¥–æ–∫–∞–Ω–∞–ª22': '–ë–∞—Ä–Ω–∞—É–ª',
    '–≤–æ–¥–æ–∫–∞–Ω–∞–ª04': '–ì–æ—Ä–Ω–æ-–ê–ª—Ç–∞–π—Å–∫',
    '–≤–æ–¥–æ–∫–∞–Ω–∞–ª42': '–ö–µ–º–µ—Ä–æ–≤–æ',
    '–≤–æ–¥–æ–∫–∞–Ω–∞–ª19': '–ê–±–∞–∫–∞–Ω',
    '–≤–æ–¥–æ–∫–∞–Ω–∞–ª17': '–ö—ã–∑—ã–ª',
    '–≤–æ–¥–æ–∫–∞–Ω–∞–ª75': '–ß–∏—Ç–∞',
    '–≤–æ–¥–æ–∫–∞–Ω–∞–ª28': '–ë–ª–∞–≥–æ–≤–µ—â–µ–Ω—Å–∫',
    '–≤–æ–¥–æ–∫–∞–Ω–∞–ª79': '–ë–∏—Ä–æ–±–∏–¥–∂–∞–Ω',
    '–≤–æ–¥–æ–∫–∞–Ω–∞–ª65': '–Æ–∂–Ω–æ-–°–∞—Ö–∞–ª–∏–Ω—Å–∫',
    '–≤–æ–¥–æ–∫–∞–Ω–∞–ª41': '–ü–µ—Ç—Ä–æ–ø–∞–≤–ª–æ–≤—Å–∫-–ö–∞–º—á–∞—Ç—Å–∫–∏–π',
    '–≤–æ–¥–æ–∫–∞–Ω–∞–ª49': '–ú–∞–≥–∞–¥–∞–Ω',
    '–≤–æ–¥–æ–∫–∞–Ω–∞–ª14': '–Ø–∫—É—Ç—Å–∫',
    '–≤–æ–¥–æ–∫–∞–Ω–∞–ª87': '–ê–Ω–∞–¥—ã—Ä—å',
    '–≤–æ–¥–æ–∫–∞–Ω–∞–ª39': '–ö–∞–ª–∏–Ω–∏–Ω–≥—Ä–∞–¥',
    '–≤–æ–¥–æ–∫–∞–Ω–∞–ª60': '–ü—Å–∫–æ–≤',
    '–≤–æ–¥–æ–∫–∞–Ω–∞–ª53': '–í–µ–ª–∏–∫–∏–π –ù–æ–≤–≥–æ—Ä–æ–¥',
    '–≤–æ–¥–æ–∫–∞–Ω–∞–ª69': '–¢–≤–µ—Ä—å',
    '–≤–æ–¥–æ–∫–∞–Ω–∞–ª67': '–°–º–æ–ª–µ–Ω—Å–∫',
    '–≤–æ–¥–æ–∫–∞–Ω–∞–ª32': '–ë—Ä—è–Ω—Å–∫',
    '–≤–æ–¥–æ–∫–∞–Ω–∞–ª50': '–ü–æ–¥–æ–ª—å—Å–∫',
    '–≤–æ–¥–æ–∫–∞–Ω–∞–ª77': '–ú–æ—Å–∫–≤–∞',
    '–≤–æ–¥–æ–∫–∞–Ω–∞–ª78': '–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥',
    '–≤–æ–¥–æ–∫–∞–Ω–∞–ª47': '–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥',
    // –ü–æ–≤–µ—Ä–∫–∏
    'poverka64': '–°–∞—Ä–∞—Ç–æ–≤',
    'poverka63': '–°–∞–º–∞—Ä–∞',
    'poverka55': '–û–º—Å–∫',
    'poverka76': '–Ø—Ä–æ—Å–ª–∞–≤–ª—å',
    // –î–æ–±–∞–≤–ª—è–π—Ç–µ –Ω–æ–≤—ã–µ —Å–∞–π—Ç—ã –∑–¥–µ—Å—å...
  };

  /**
   * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –∑–∞—è–≤–∫–æ–π —Å —Å–∞–π—Ç–∞
   */
  isSiteOrderMessage(text: string): boolean {
    return text.includes('–ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞');
  }

  /**
   * –ü–∞—Ä—Å–∏—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–∑ Telegram –∏ –∏–∑–≤–ª–µ–∫–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∑–∞—è–≤–∫–∏
   */
  parse(text: string): ParsedSiteOrder | null {
    if (!this.isSiteOrderMessage(text)) {
      return null;
    }

    try {
      const result: Partial<ParsedSiteOrder> = {};
      const commentParts: string[] = [];

      // –ü–∞—Ä—Å–∏–º —Å–∞–π—Ç –∏ –≥–æ—Ä–æ–¥ –∏–∑ –∑–∞–≥–æ–ª–æ–≤–∫–∞
      // –§–æ—Ä–º–∞—Ç 1: "–ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞ —Å –í–æ–¥–æ–∫–∞–Ω–∞–ª55 (–û–º—Å–∫)"
      // –§–æ—Ä–º–∞—Ç 2: "–ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞ —Å —Å–∞–π—Ç–∞ poverka64"
      const siteMatch = text.match(/–ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞ —Å (?:—Å–∞–π—Ç–∞\s+)?(\S+)(?:\s+\(([^)]+)\))?/i);
      if (siteMatch) {
        result.site = siteMatch[1];
        result.city = siteMatch[2] || this.extractCityFromSite(siteMatch[1]) || '–ù–µ–∏–∑–≤–µ—Å—Ç–µ–Ω';
      }

      // –ü–∞—Ä—Å–∏–º –∏–º—è –∫–ª–∏–µ–Ω—Ç–∞
      const nameMatch = text.match(/üë§\s*–ò–º—è:\s*(.+)/i);
      if (nameMatch) {
        result.clientName = nameMatch[1].trim();
      }

      // –ü–∞—Ä—Å–∏–º —Ç–µ–ª–µ—Ñ–æ–Ω
      const phoneMatch = text.match(/üìû\s*–¢–µ–ª–µ—Ñ–æ–Ω:\s*(.+)/i);
      if (phoneMatch) {
        result.phone = this.normalizePhone(phoneMatch[1].trim());
      }

      // –ü–∞—Ä—Å–∏–º —Ç–∏–ø –∑–∞—è–≤–∫–∏ (–¥–ª—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è)
      const typeMatch = text.match(/üìã\s*–¢–∏–ø –∑–∞—è–≤–∫–∏:\s*(.+)/i);
      if (typeMatch) {
        commentParts.push(`–¢–∏–ø: ${typeMatch[1].trim()}`);
      }

      // –ü–∞—Ä—Å–∏–º –∞–¥—Ä–µ—Å
      const addressMatch = text.match(/üè†\s*–ê–¥—Ä–µ—Å:\s*(.+)/i);
      if (addressMatch) {
        commentParts.push(`–ê–¥—Ä–µ—Å: ${addressMatch[1].trim()}`);
      }

      // –ü–∞—Ä—Å–∏–º —É—Å–ª—É–≥—É
      const serviceMatch = text.match(/üîß\s*–£—Å–ª—É–≥–∞:\s*(.+)/i);
      if (serviceMatch) {
        commentParts.push(`–£—Å–ª—É–≥–∞: ${serviceMatch[1].trim()}`);
      }

      // –ü–∞—Ä—Å–∏–º –≥–æ—Ä–æ–¥ –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è (–µ—Å–ª–∏ –µ—Å—Ç—å –æ—Ç–¥–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ)
      const cityMatch = text.match(/üìç\s*–ì–æ—Ä–æ–¥:\s*(.+)/i);
      if (cityMatch) {
        result.city = cityMatch[1].trim();
      }

      // –ü–∞—Ä—Å–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—á–µ—Ç—á–∏–∫–æ–≤
      const countersMatch = text.match(/üî¢\s*–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—á–µ—Ç—á–∏–∫–æ–≤:\s*(.+)/i);
      if (countersMatch) {
        commentParts.push(`–°—á–µ—Ç—á–∏–∫–æ–≤: ${countersMatch[1].trim()}`);
      }

      // –ü–∞—Ä—Å–∏–º –≤—Ä–µ–º—è –∑–∞—è–≤–∫–∏
      const timeMatch = text.match(/‚è∞\s*–í—Ä–µ–º—è:\s*(.+)/i);
      if (timeMatch) {
        commentParts.push(`–í—Ä–µ–º—è –∑–∞—è–≤–∫–∏: ${timeMatch[1].trim()}`);
      }

      // –°–æ–±–∏—Ä–∞–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
      if (commentParts.length > 0) {
        result.comment = commentParts.join('\n');
      }

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è
      if (!result.site || !result.clientName || !result.phone) {
        this.logger.warn(`Failed to parse site order: missing required fields. Site: ${result.site}, Name: ${result.clientName}, Phone: ${result.phone}`);
        return null;
      }

      this.logger.log(`‚úÖ Parsed site order: ${result.site} - ${result.clientName} (${result.city})`);
      return result as ParsedSiteOrder;
    } catch (error) {
      this.logger.error(`Error parsing site order: ${error.message}`);
      return null;
    }
  }

  /**
   * –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞: +7 (904) 586-26-04 -> +79045862604
   */
  private normalizePhone(phone: string): string {
    // –£–¥–∞–ª—è–µ–º –≤—Å–µ –∫—Ä–æ–º–µ —Ü–∏—Ñ—Ä –∏ +
    let normalized = phone.replace(/[^\d+]/g, '');
    
    // –ï—Å–ª–∏ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å 8, –∑–∞–º–µ–Ω—è–µ–º –Ω–∞ +7
    if (normalized.startsWith('8') && normalized.length === 11) {
      normalized = '+7' + normalized.slice(1);
    }
    
    // –ï—Å–ª–∏ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å 7 –±–µ–∑ +, –¥–æ–±–∞–≤–ª—è–µ–º +
    if (normalized.startsWith('7') && normalized.length === 11) {
      normalized = '+' + normalized;
    }
    
    return normalized;
  }

  /**
   * –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –≥–æ—Ä–æ–¥–∞ –∏–∑ –Ω–∞–∑–≤–∞–Ω–∏—è —Å–∞–π—Ç–∞ –ø–æ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫—É
   */
  private extractCityFromSite(site: string): string | null {
    const siteLower = site.toLowerCase();
    return this.siteToCity[siteLower] || null;
  }

  /**
   * –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π —Å–∞–π—Ç –≤ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫ (runtime)
   */
  addSiteMapping(site: string, city: string): void {
    this.siteToCity[site.toLowerCase()] = city;
    this.logger.log(`Added site mapping: ${site} -> ${city}`);
  }
}
