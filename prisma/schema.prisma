generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Настройки директоров для уведомлений
model Director {
  id            Int           @id @default(autoincrement())
  cities        String[]
  name          String
  login         String        @unique
  password      String
  contractDoc   String?       @map("contract_doc")
  passportDoc   String?       @map("passport_doc")
  dateCreate    DateTime      @default(now()) @map("date_create")
  note          String?
  tgId          String?       @map("tg_id")
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")
  
  // ✅ FIX #163: Индекс для поиска директора по Telegram ID
  @@index([tgId])
  @@map("director")
}

// Настройки мастеров для уведомлений
model Master {
  id            Int           @id @default(autoincrement())
  cities        String[]
  name          String
  login         String?       @unique
  password      String?
  passportDoc   String?       @map("passport_doc")
  contractDoc   String?       @map("contract_doc")
  statusWork    String        @map("status_work")
  dateCreate    DateTime      @default(now()) @map("date_create")
  note          String?
  tgId          String?       @map("tg_id")
  chatId        String?       @map("chat_id")
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")
  
  orders        Order[]
  
  // ✅ FIX #163: Индексы для быстрого поиска мастеров
  @@index([tgId])                               // Поиск по Telegram ID
  @@index([chatId])                             // Поиск по Chat ID
  @@index([statusWork])                         // Фильтрация по статусу работы
  @@map("master")
}

// Для связи с заказами (read-only)
model Order {
  id                    Int       @id @default(autoincrement())
  rk                    String
  city                  String
  avitoName             String?   @map("avito_name")
  phone                 String
  typeOrder             String    @map("type_order")
  clientName            String    @map("client_name")
  address               String
  dateMeeting           DateTime  @map("date_meeting")
  typeEquipment         String    @map("type_equipment")
  problem               String
  callRecord            String?   @map("call_record")
  statusOrder           String    @map("status_order")
  masterId              Int?      @map("master_id")
  result                Decimal?  @db.Decimal(10, 2)
  expenditure           Decimal?  @db.Decimal(10, 2)
  clean                 Decimal?  @db.Decimal(10, 2)
  masterChange          Decimal?  @map("master_change") @db.Decimal(10, 2)
  operatorNameId        Int       @map("operator_name_id")
  createDate            DateTime  @map("create_date")
  closingData           DateTime? @map("closing_data")
  dateClosmod           DateTime? @map("date_closmod")
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")
  
  // ✅ FIX #146: SetNull - заказ остаётся, мастер открепляется
  master                Master?   @relation(fields: [masterId], references: [id], onDelete: SetNull)
  
  // ✅ FIX #163: Индексы для быстрых запросов в notifications-service
  @@index([masterId])                           // Уведомления мастеру
  @@index([city])                               // Уведомления директору по городу
  @@index([statusOrder])                        // Фильтрация по статусу
  @@index([dateMeeting])                        // Напоминания о встречах
  @@index([createDate(sort: Desc)])             // Сортировка по дате создания
  @@index([city, statusOrder])                  // Комбинированный для директоров
  @@index([masterId, statusOrder])              // Комбинированный для мастеров
  @@map("orders")
}

// Логи ошибок (shared with auth-service)
model ErrorLog {
  id             Int      @id @default(autoincrement())
  timestamp      DateTime @default(now())
  service        String   @db.VarChar(100)
  errorType      String   @db.VarChar(255)
  errorMessage   String   @db.Text
  stackTrace     String?  @db.Text
  userId         Int?
  userRole       String?  @db.VarChar(50)
  requestUrl     String?  @db.VarChar(500)
  requestMethod  String?  @db.VarChar(10)
  ip             String?  @db.VarChar(45)
  userAgent      String?  @db.Text
  metadata       Json?    @db.JsonB

  @@index([timestamp(sort: Desc)])
  @@index([service, timestamp(sort: Desc)])
  @@index([errorType])
  @@index([userId])
  @@map("error_logs")
}


