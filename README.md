# Notifications Service

Микросервис для отправки уведомлений через Telegram директорам и мастерам.

## Функционал

### Уведомления Директорам 📢
- 🆕 **Новый заказ** - уведомление директору города при создании заказа
- 📅 **Изменение даты встречи** - уведомление при переносе даты
- ❌ **Отказ от заказа** - уведомление при отмене заказа
- 🎯 Автоматическая фильтрация по городам

### Уведомления Мастерам 🔧
- 👷 **Назначен на заказ** - уведомление при назначении мастера
- 📅 **Изменение даты встречи** - уведомление о переносе даты (если мастер уже назначен)
- ❌ **Отказ от заказа** - уведомление об отмене (если мастер уже назначен)
- ✅ **Заказ принят** - подтверждение принятия заказа
- 🔒 **Заказ закрыт** - уведомление о закрытии заказа
- 🕐 **Заказ в модерне** - уведомление о модерации с ожидаемой датой закрытия
- ⚠️ **Напоминание закрыть заказ** - автоматическое (через 3ч, потом каждые 3ч)
- 📆 **Напоминание о закрытии модерна** - автоматическое (раз в день в 10:00)

### История уведомлений
- Логирование всех отправленных уведомлений
- Раздельное хранение для директоров и мастеров
- Статусы отправки (pending, sent, failed)
- Фильтрация по типу получателя, типу уведомления, статусу

## API Endpoints

### Уведомления Директорам
- `POST /api/v1/notifications/send` - Универсальная отправка уведомления
- `POST /api/v1/notifications/new-order` - Новый заказ (Директор)
- `POST /api/v1/notifications/date-change` - Изменение даты (Директор + Мастер если назначен)
- `POST /api/v1/notifications/order-rejection` - Отказ от заказа (Директор + Мастер если назначен)

### Уведомления Мастерам
- `POST /api/v1/notifications/master-assigned` - Мастер назначен на заказ
- `POST /api/v1/notifications/order-accepted` - Заказ принят мастером
- `POST /api/v1/notifications/order-closed` - Заказ закрыт
- `POST /api/v1/notifications/order-in-modern` - Заказ в модерации
- `POST /api/v1/notifications/close-order-reminder` - Напоминание закрыть заказ
- `POST /api/v1/notifications/modern-closing-reminder` - Напоминание о закрытии модерна

### История и Статистика
- `GET /api/v1/notifications/history` - История уведомлений
- `GET /api/v1/notifications/stats` - Статистика отправок

### Управление Директорами
- `GET /api/v1/directors` - Список директоров
- `GET /api/v1/directors/:id` - Информация о директоре
- `PUT /api/v1/directors/:id/telegram` - Обновить Telegram данные
- `PUT /api/v1/directors/:id/cities` - Обновить города директора

### Управление Мастерами
- `GET /api/v1/masters` - Список мастеров
- `GET /api/v1/masters/:id` - Информация о мастере
- `GET /api/v1/masters/by-cities?cities=Москва,Саратов` - Мастера по городам
- `PUT /api/v1/masters/:id/telegram` - Обновить Telegram данные
- `PUT /api/v1/masters/:id/cities` - Обновить города мастера

## Environment Variables

```env
DATABASE_URL=postgresql://user:pass@host:port/db
JWT_SECRET=your-secret
PORT=5008
TELEGRAM_BOT_TOKEN=your-bot-token
TELEGRAM_API_URL=https://api.telegram.org
WEBHOOK_TOKEN=your-webhook-secret

# Настройки автоматических напоминаний

# Напоминание закрыть заказ (статус: Принял/В пути/В работе)
FIRST_REMINDER_HOURS=3       # Первое напоминание через N часов после dateMeeting (по умолчанию 3)
REMINDER_INTERVAL_HOURS=3    # Интервал повторных напоминаний в часах (по умолчанию 3)

# Напоминание о модерне (статус: Модерн)
MODERN_REMINDER_DAYS=3       # Первое напоминание через N дней (если нет dateClosmod)
                             # Повторные - каждый день в 10:00
```

## Форматы Уведомлений

### Новый заказ (Директор)
```json
{
  "orderId": 123,
  "city": "Саратов",
  "clientName": "Иван Петров",
  "phone": "+79001234567",
  "address": "ул. Пушкина, д. 10",
  "dateMeeting": "2025-01-15T10:00:00Z",
  "problem": "Не работает холодильник",
  "rk": "Яндекс",
  "avitoName": "Avito_Saratov",
  "typeEquipment": "БТ",
  "token": "your-webhook-secret"
}
```

### Изменение даты (Директор + Мастер)
```json
{
  "orderId": 123,
  "city": "Саратов",
  "clientName": "Иван Петров",
  "newDate": "2025-01-20T14:00:00Z",
  "oldDate": "2025-01-15T10:00:00Z",
  "masterId": 5,
  "token": "your-webhook-secret"
}
```

### Отказ от заказа (Директор + Мастер)
```json
{
  "orderId": 123,
  "city": "Саратов",
  "clientName": "Иван Петров",
  "phone": "+79001234567",
  "reason": "Клиент отказался от услуги",
  "masterId": 5,
  "token": "your-webhook-secret"
}
```

### Мастер назначен на заказ
```json
{
  "orderId": 123,
  "masterId": 5,
  "rk": "Яндекс",
  "avitoName": "Avito_Saratov",
  "typeEquipment": "БТ",
  "clientName": "Иван Петров",
  "address": "ул. Пушкина, д. 10",
  "dateMeeting": "2025-01-15T10:00:00Z",
  "token": "your-webhook-secret"
}
```

### Заказ в модерне
```json
{
  "orderId": 123,
  "masterId": 5,
  "expectedClosingDate": "2025-01-20T00:00:00Z",
  "clientName": "Иван Петров",
  "token": "your-webhook-secret"
}
```

### Напоминание о закрытии заказа
```json
{
  "orderId": 123,
  "masterId": 5,
  "clientName": "Иван Петров",
  "daysOverdue": 3,
  "token": "your-webhook-secret"
}
```

## Шаблоны сообщений

> 💡 Шаблоны хардкод в файле `src/notifications/message-templates.ts`

### Для Директоров

#### new_order
```
🆕 Поступил новый заказ №{orderId}

РК: {rk}
Авито: {avitoName}
Направление: {typeEquipment}

👤 Клиент: {clientName}
📞 Телефон: {phone}
📍 Адрес: {address}
🗓 Дата встречи: {dateMeeting}
🔧 Проблема: {problem}
🏙 Город: {city}
```

#### date_change
```
📅 Заказ №{orderId} перенесен на {newDate}

👤 Клиент: {clientName}
🏙 Город: {city}
```

#### order_rejection
```
❌ Заказ №{orderId} Отменен

👤 Клиент: {clientName}
📞 Телефон: {phone}
💬 Причина: {reason}
🏙 Город: {city}
```

### Для Мастеров

#### master_assigned
```
👷 Вам назначен заказ №{orderId}

РК: {rk}
Авито: {avitoName}
Направление: {typeEquipment}

👤 Клиент: {clientName}
📍 Адрес: {address}
🗓 Дата встречи: {dateMeeting}

⚠️ Подтвердите принятие заказа в ЦРМ!
```

#### date_change (для мастера)
```
📅 Заказ №{orderId} перенесен на {newDate}

👤 Клиент: {clientName}
```

#### order_rejection (для мастера)
```
❌ Заказ №{orderId} Отменен

👤 Клиент: {clientName}
💬 Причина: {reason}
```

#### order_accepted
```
✅ Заказ №{orderId} принят

👤 Клиент: {clientName}
```

#### order_closed
```
🔒 Заказ №{orderId} закрыт

👤 Клиент: {clientName}
📅 Дата закрытия: {closingDate}
```

#### order_in_modern
```
🕐 Заказ №{orderId} в модерне

👤 Клиент: {clientName}
📆 Ожидаемая дата закрытия: {expectedClosingDate}
```

#### close_order_reminder
```
⚠️ Закройте заказ №{orderId}

👤 Клиент: {clientName}
⏰ Просрочен на {daysOverdue} дн.
```

#### modern_closing_reminder

Нет даты:
```
📆 Напоминание о закрытии модерна

📋 Заказ №{orderId}
👤 Клиент: {clientName}
📅 Дата закрытия: Не указано
⚠️ Нужно закрыть модерн!
```

В день закрытия:
```
📆 Напоминание о закрытии модерна

📋 Заказ №{orderId}
👤 Клиент: {clientName}
📅 Дата закрытия: {expectedClosingDate}
⏰ Сегодня день закрытия!
```

Просрочка:
```
📆 Напоминание о закрытии модерна

📋 Заказ №{orderId}
👤 Клиент: {clientName}
📅 Дата закрытия: {expectedClosingDate}
⚠️ Просрочено на {daysOverdue} дн.
```

## Docker

```bash
docker build -t notifications-service .
docker run -p 5008:5008 notifications-service
```

## Интеграция с Telegram Bot

### Настройка бота
1. Создайте бота через @BotFather в Telegram
2. Получите токен бота
3. Добавьте токен в `.env` как `TELEGRAM_BOT_TOKEN`
4. Установите WEBHOOK_TOKEN для защиты API

### Настройка для Директоров
1. Директор запускает вашего бота в Telegram
2. Получите `tgId` директора (chat_id)
3. Обновите через API:
```bash
PUT /api/v1/directors/:id/telegram
{
  "tgId": "123456789"
}
```
4. Настройте города директора:
```bash
PUT /api/v1/directors/:id/cities
{
  "cities": ["Москва", "Саратов"]
}
```

### Настройка для Мастеров
1. Мастер запускает вашего бота в Telegram
2. Получите `tgId` и `chatId` мастера
3. Обновите через API:
```bash
PUT /api/v1/masters/:id/telegram
{
  "tgId": "987654321",
  "chatId": "987654321"
}
```
4. Города мастера обычно уже настроены в основной БД

## Типы Уведомлений по Сценариям

### Сценарий 1: Оператор создает заказ
**Кто получает**: Директор города заказа  
**Endpoint**: `POST /api/v1/notifications/new-order`  
**Сообщение**: "Поступил новый заказ №... РК: ... Авито: ... Направление: БТ"

### Сценарий 2: Оператор меняет дату встречи
**Кто получает**: Директор города + Мастер (если назначен)  
**Endpoint**: `POST /api/v1/notifications/date-change`  
**Параметр**: `masterId` (опционально)  
**Сообщение**: "Заказ №... перенесен на 10.10.2025 15:00"

### Сценарий 3: Оператор меняет статус на "Отказ/Незаказ"
**Кто получает**: Директор города + Мастер (если назначен)  
**Endpoint**: `POST /api/v1/notifications/order-rejection`  
**Параметр**: `masterId` (опционально)  
**Сообщение**: "Заказ №... Отменен"

### Сценарий 4: Директор назначает мастера на заказ
**Кто получает**: Мастер  
**Endpoint**: `POST /api/v1/notifications/master-assigned`  
**Параметр**: `masterId` (обязательно)  
**Сообщение**: "Вам назначен заказ №... РК: ... Авито: ... Направление: БТ. Подтвердите принятие заказа в ЦРМ!"

### Дополнительные сценарии для мастеров:
- **Заказ в модерне**: `POST /api/v1/notifications/order-in-modern`
- **Напоминание закрыть**: `POST /api/v1/notifications/close-order-reminder`
- **Напоминание о модерне**: `POST /api/v1/notifications/modern-closing-reminder`

---

## 🤖 Автоматические Напоминания (Cron Jobs)

Notifications-service **автоматически** проверяет заказы и отправляет напоминания мастерам по расписанию.

### 1. Напоминание закрыть заказ ⚠️

**Расписание**: Каждый час проверяет заказы  

**Условия**:
- Статус заказа: `"Принял"`, `"В пути"` или `"В работе"`
- Мастер назначен на заказ

**Логика напоминаний**:
1. **Первое напоминание** → через **3 часа** после `dateMeeting`
   - Встреча в 10:00 → напоминание в 13:00
2. **Повторные напоминания** → каждые **3 часа** после предыдущего
   - 13:00 → 16:00 → 19:00 → 22:00 → и т.д.
3. **Пока мастер не закроет** заказ (статус изменится)

**Пример**:
```
📅 Дата встречи: 10.10.2025 10:00
📋 Статус: "Принял"

⏰ 13:00 → 1-е напоминание ✉️
⏰ 16:00 → 2-е напоминание ✉️
⏰ 19:00 → 3-е напоминание ✉️
⏰ 22:00 → 4-е напоминание ✉️
... пока не закроет
```

**Код логики**:
```typescript
// Первое напоминание через 3 часа
if (hoursSinceMeeting >= 3 && !lastNotification) {
  sendReminder();
}

// Повторные каждые 3 часа
if (hoursSinceLastReminder >= 3) {
  sendReminder();
}
```

**Сообщение мастеру**:
```
⚠️ Закройте заказ №123
👤 Клиент: Иван Петров
⏰ Просрочен на 0 дн.
```

### 2. Напоминание о закрытии модерна 📆

**Расписание**: Каждый день в 10:00  
**Условия**: Статус заказа `"Модерн"` и мастер назначен

#### Вариант А: НЕТ даты закрытия модерна (`dateClosmod = null`)

**Логика**:
1. **Первое напоминание** → через **3 дня** после установки статуса "Модерн"
2. **Повторные напоминания** → **каждый день** в 10:00

**Пример**:
```
Статус "Модерн" установлен: 01.11.2025
dateClosmod: null

📅 04.11.2025 10:00 → 1-е напоминание ✉️
📅 05.11.2025 10:00 → 2-е напоминание ✉️
📅 06.11.2025 10:00 → 3-е напоминание ✉️
... каждый день пока не закроет
```

**Сообщение**:
```
📆 Напоминание о закрытии модерна
📋 Заказ №123
👤 Клиент: Иван Петров
📅 Дата закрытия: Не указано
⚠️ Нужно закрыть модерн!
```

#### Вариант Б: ЕСТЬ дата закрытия модерна (`dateClosmod != null`)

**Логика**:
1. **В день закрытия** → напоминание в 10:00
2. **Если не закрыл** → каждый день в 10:00 о просрочке

**Пример**:
```
dateClosmod: 05.11.2025

📅 05.11.2025 10:00 → "Сегодня день закрытия!" ✉️
📅 06.11.2025 10:00 → "Просрочено на 1 дн." ✉️
📅 07.11.2025 10:00 → "Просрочено на 2 дн." ✉️
... каждый день пока не закроет
```

**Сообщения**:

День закрытия:
```
📆 Напоминание о закрытии модерна
📋 Заказ №123
👤 Клиент: Иван Петров
📅 Дата закрытия: 05.11.2025
⏰ Сегодня день закрытия!
```

Просрочка:
```
📆 Напоминание о закрытии модерна
📋 Заказ №123
👤 Клиент: Иван Петров
📅 Дата закрытия: 05.11.2025
⚠️ Просрочено на 2 дн.
```

---

## 🔧 Настройка Автоматических Напоминаний

### Изменить интервалы напоминаний

В `.env`:
```bash
# Первое напоминание через 2 часа вместо 3
FIRST_REMINDER_HOURS=2

# Повторять каждые 2 часа вместо 3
REMINDER_INTERVAL_HOURS=2

# Модерн (без даты): первое напоминание через 2 дня вместо 3
MODERN_REMINDER_DAYS=2
```

**Пример**: Если хочешь чтобы напоминали чаще:
```bash
FIRST_REMINDER_HOURS=1     # Первое через 1 час
REMINDER_INTERVAL_HOURS=1   # Потом каждый час
```

### Отключить автоматические напоминания

Если нужно временно отключить cron-задачи, закомментируй декораторы `@Cron` в файле:
```
src/reminders/reminders.service.ts
```

### Изменить расписание

В `src/reminders/reminders.service.ts`:

```typescript
// Вместо каждого часа - каждые 30 минут
@Cron('*/30 * * * *')

// Вместо 10:00 - в 9:00 и 18:00
@Cron('0 9,18 * * *')
```

[Генератор cron выражений](https://crontab.guru/)

